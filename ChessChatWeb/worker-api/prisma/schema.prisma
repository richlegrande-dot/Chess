generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AdminSession {
  id        String   @id
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model ChatSession {
  id         String     @id
  gameId     String
  messages   String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime
  GameRecord GameRecord @relation(fields: [gameId], references: [id], onDelete: Cascade)
}

model GameRecord {
  id             String           @id
  pgn            String
  result         String
  playerColor    String
  difficulty     String
  createdAt      DateTime         @default(now())
  ChatSession    ChatSession[]
  TakeawayRecord TakeawayRecord[]
  GameAnalysis   GameAnalysis?    // One-to-one relation
}

model KnowledgeChunk {
  id              String          @id
  sourceId        String
  chunkText       String
  tags            String
  language        String?
  metadata        String?
  createdAt       DateTime        @default(now())
  KnowledgeSource KnowledgeSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)
}

model KnowledgeEditLog {
  id         String   @id
  actor      String
  action     String
  entityType String
  entityId   String
  beforeJson String?
  afterJson  String?
  createdAt  DateTime @default(now())
}

model KnowledgeSource {
  id             String           @id
  title          String
  sourceType     String
  url            String?
  isDeleted      Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  KnowledgeChunk KnowledgeChunk[]
}

model LearningMetric {
  id                 String        @id
  userId             String
  sessionId          String
  sessionStart       DateTime
  sessionEnd         DateTime?
  gamesInSession     Int           @default(0)
  averageAccuracy    Float         @default(0.0)
  improvementDelta   Float         @default(0.0)
  areasImproved      String
  areasRegressed     String
  newPatternsLearned Int           @default(0)
  keyInsights        String
  progressMade       String
  createdAt          DateTime      @default(now())
  PlayerProfile      PlayerProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId, sessionStart])
}

model MistakeSignature {
  id               String        @id
  userId           String
  category         String
  title            String
  mistakeType      String
  motifs           String
  positionTypes    String
  occurrences      Int           @default(1)
  lastSeen         DateTime      @default(now())
  confidenceScore  Float         @default(0.0)
  masteryScore     Float         @default(0.0)
  exampleGames     String
  principleText    String?
  coachingAdvice   String?
  teachingAttempts Int           @default(0)
  successfulGames  Int           @default(0)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime
  PlayerProfile    PlayerProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId, category])
  @@index([userId, masteryScore])
}

model PlayerProfile {
  id               String             @id
  userId           String             @unique
  tacticalRating   Int                @default(50)
  positionalRating Int                @default(50)
  endgameRating    Int                @default(50)
  openingRating    Int                @default(50)
  gamesPlayed      Int                @default(0)
  improvementRate  Float              @default(0.0)
  strengthAreas    String
  weaknessAreas    String
  playStyle        String             @default("balanced")
  commonMistakes   String
  favoriteOpenings String
  ratingHistory    String
  milestones       String
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  LearningMetric   LearningMetric[]
  MistakeSignature MistakeSignature[]
  TrainingGame     TrainingGame[]
}

model TakeawayRecord {
  id         String     @id
  gameId     String
  text       String
  themeTags  String
  createdAt  DateTime   @default(now())
  GameRecord GameRecord @relation(fields: [gameId], references: [id], onDelete: Cascade)
}

model TrainingGame {
  id               String        @id
  userId           String
  gameIndex        Int
  pgn              String
  fen              String?
  result           String
  playerColor      String
  moveCount        Int
  cpuLevel         Int
  tacticalPatterns String
  strategicIssues  String
  mistakeEvents    String
  decisionMoments  String
  blunders         Int           @default(0)
  mistakes         Int           @default(0)
  inaccuracies     Int           @default(0)
  accuracy         Float         @default(0.0)
  openingPerf      String?
  middlegamePerf   String?
  endgamePerf      String?
  topImprovements  String
  encouragement    String?
  tacticalFocus    String?
  strategicFocus   String?
  createdAt        DateTime      @default(now())
  PlayerProfile    PlayerProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, gameIndex])
  @@index([userId, createdAt])
}


// ============= NEW: WORKER API OBSERVABILITY =============

model WorkerCallLog {
  id           String   @id @default(uuid())
  ts           DateTime @default(now())
  endpoint     String
  method       String
  success      Boolean
  latencyMs    Int
  cpuLevel     Int?
  timeMs       Int?
  difficulty   String?
  mode         String
  engine       String
  error        String?
  requestJson  Json
  responseJson Json?

  @@index([ts(sort: Desc)])
  @@map("worker_call_logs")
}

// ============= NEW: GAME ANALYSIS LAYER =============

model GameAnalysis {
  id                String     @id @default(uuid())
  gameId            String     @unique
  status            String     @default("pending") // pending | processing | completed | failed
  
  // Analysis results
  positions         Json?      // Array of position analyses
  blunders          Json?      // Array of blunder details
  mistakes          Json?      // Array of mistake details
  inaccuracies      Json?      // Array of inaccuracy details
  
  // Aggregate metrics
  avgCentipawnLoss  Float?
  accuracyScore     Float?
  tacticalThemes    Json?      // Detected tactical patterns
  positionalThemes  Json?      // Positional weaknesses
  keyMoments        Json?      // Critical decision points
  
  // Metadata
  analyzedAt        DateTime?
  analysisDuration  Int?       // milliseconds
  error             String?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  
  game              GameRecord @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("game_analyses")
}

// ============= NEW: AI COACHING CALL LOGS =============

model AICallLog {
  id           String   @id @default(uuid())
  ts           DateTime @default(now())
  endpoint     String   // /assist/postgame or /assist/explain
  requestType  String   // "postgame" | "explain"
  success      Boolean
  latencyMs    Int
  
  // Request/Response data
  gameId       String?
  playerId     String?
  requestJson  Json
  responseJson Json?
  
  // AI metadata
  promptTokens Int?
  completionTokens Int?
  totalTokens  Int?
  model        String?
  
  error        String?
  
  @@index([ts(sort: Desc)])
  @@index([playerId])
  @@map("ai_call_logs")
}

// ============= LEARNING LAYER V3: CONCEPT-BASED MASTERY SYSTEM =============

// User's mastery state for each chess concept
model UserConceptState {
  id              String   @id @default(uuid())
  userId          String
  conceptId       String   // e.g., "hanging_pieces", "back_rank_mate"
  
  // Mastery tracking (0.0 to 1.0)
  mastery         Float    @default(0.5)
  confidence      Float    @default(0.0)  // Amount of data collected
  
  // Performance metrics (Exponential Moving Average)
  mistakeRateEMA  Float    @default(0.0)  // Mistakes per game
  successRateEMA  Float    @default(0.0)  // Successful avoidances per game
  
  // Spaced repetition
  spacedRepDueAt  DateTime @default(now())
  lastSeenAt      DateTime?
  lastPracticedAt DateTime?
  
  // Evidence trail (JSON array of {gameId, moveNum, delta})
  evidenceRefs    Json     @default("[]")
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([userId, conceptId])
  @@index([userId, mastery])
  @@index([userId, spacedRepDueAt])
  @@map("user_concept_states")
}

// Coaching action tracking with outcome measurement
model AdviceIntervention {
  id                  String   @id @default(uuid())
  userId              String
  gameId              String?  // Game where advice was given
  
  // What was advised
  conceptsTargeted    Json     // Array of concept IDs
  adviceText          String   // Summary of advice (not full response)
  messageHash         String   // Hash for deduplication
  
  // Expected outcome
  expectedBehavior    String   // Description of desired change
  measurementCriteria Json     // What to measure and thresholds
  
  // Evaluation window
  evaluationGames     Int      @default(5)  // Next N games to evaluate
  gamesEvaluated      Int      @default(0)  // Progress counter
  
  // Outcomes (filled after evaluation)
  outcome             String?  // "success" | "partial" | "failure" | "unknown"
  measuredDelta       Float?   // Numeric change in target metric
  followUpRequired    Boolean  @default(false)
  
  // Metadata
  createdAt           DateTime @default(now())
  evaluatedAt         DateTime?
  
  @@index([userId, createdAt])
  @@index([userId, outcome])
  @@map("advice_interventions")
}

// Weekly practice plan with target concepts
model PracticePlan {
  id                String   @id @default(uuid())
  userId            String
  
  // Plan window
  planStart         DateTime
  planEnd           DateTime
  
  // Target concepts (JSON array of {conceptId, priority, reason})
  targetConcepts    Json
  
  // Suggested exercises (JSON array of drill descriptions)
  suggestedDrills   Json
  
  // Status
  completed         Boolean  @default(false)
  adherenceScore    Float?   // 0.0-1.0 based on actual practice
  
  // Metadata
  createdAt         DateTime @default(now())
  
  @@index([userId, planStart])
  @@map("practice_plans")
}

// Event log for learning system actions
model LearningEvent {
  id          String   @id @default(uuid())
  ts          DateTime @default(now())
  userId      String?
  eventType   String   // GAME_INGESTED | CONCEPT_UPDATED | ADVICE_ISSUED | ADVICE_EVALUATED
  payload     Json     // Event-specific data (bounded size)
  
  @@index([ts(sort: Desc)])
  @@index([userId, ts])
  @@map("learning_events")
}
