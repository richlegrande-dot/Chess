name = "chesschat-worker-api"
main = "src/index.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

# Routes - attach to domain (chesschat.uk/api/* → this Worker)
routes = [
  { pattern = "chesschat.uk/api/*", zone_name = "chesschat.uk" }
]

[build]
command = "npm run prisma:generate"

# Environment variables (non-secret)
[vars]
ENVIRONMENT = "production"
VERSION = "2.0.0"
# Optional: Enable keep-warm pings to prevent Render cold starts
# ENABLE_STOCKFISH_KEEPWARM = "true"

# Learning Layer V3 Feature Flags (default: SAFE)
LEARNING_V3_ENABLED = "true"
LEARNING_V3_READONLY = "false"
LEARNING_V3_SHADOW_MODE = "false"
LEARNING_V3_ASYNC_ANALYSIS = "true"
LEARNING_V3_MAX_PLY_ANALYSIS = "2"
LEARNING_V3_STOCKFISH_DEPTH = "14"
LEARNING_V3_TIMEOUT_MS = "8000"
LEARNING_V3_CANARY_ENABLED = "false"
LEARNING_V3_CANARY_PERCENTAGE = "1"
LEARNING_V3_DEBUG_TIMING = "true"  # Temporary: Enable extended timeout + timing logs

# Learning V3.1 Enhancement Flags (ENABLED)
LEARNING_V3_SMART_SAMPLING = "true"        # Enable intelligent position sampling
LEARNING_V3_CACHE_ENABLED = "true"         # Enable Stockfish result caching
LEARNING_V3_MAX_POSITIONS_PER_GAME = "4"   # Max positions to analyze per game
LEARNING_V3_MAX_DB_WRITES = "50"           # Guardrail: Max DB writes per ingestion
LEARNING_V3_MAX_STOCKFISH_CALLS = "6"      # Guardrail: Max Stockfish API calls per ingestion

# Cron triggers (optional keep-warm mechanism)
# Uncomment to enable scheduled pings to Stockfish server every 10 minutes
# [[triggers.crons]]
# cron = "*/10 * * * *"

# Secrets (set via wrangler secret put)
# - DATABASE_URL (Prisma Accelerate format: prisma+postgres://accelerate.prisma-data.net/?api_key=...)
# - ADMIN_PASSWORD
# - INTERNAL_AUTH_TOKEN (optional, for AI Worker communication)

# Service bindings (to AI Coach Worker)
# NOTE: Service bindings for production are configured in Cloudflare dashboard
# Pages → Settings → Functions → Service bindings
# Variable name: AI_COACH
# Service: walle-assistant
# Environment: production

# For local development, use .dev.vars file

# ============================================================================
# STAGING ENVIRONMENT
# ============================================================================
# Deploy to staging: wrangler deploy --env staging
# Staging uses same database as production (Prisma Accelerate)
# Trade-off: Shared DB simplifies setup but staging writes affect production data
# Recommendation: Use feature flags to isolate staging behavior

[env.staging]
name = "chesschat-worker-api-staging"
routes = [
  { pattern = "chesschat.uk/api-staging/*", zone_name = "chesschat.uk" }
]

[env.staging.vars]
ENVIRONMENT = "staging"
VERSION = "2.0.0-staging"
# Learning V3: Enable for staging testing
LEARNING_V3_ENABLED = "true"
LEARNING_V3_READONLY = "false"
LEARNING_V3_SHADOW_MODE = "true"  # Start in shadow mode for safety
LEARNING_V3_ASYNC_ANALYSIS = "true"
LEARNING_V3_MAX_PLY_ANALYSIS = "2"
LEARNING_V3_STOCKFISH_DEPTH = "14"
LEARNING_V3_TIMEOUT_MS = "8000"
LEARNING_V3_CANARY_ENABLED = "false"
LEARNING_V3_CANARY_PERCENTAGE = "0"
